<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Third-Party SDK Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 1rem;
        }
        p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test de Integración SDK de Terceros</h1>
        <p>Esta página simula una integración en un sitio web de terceros.</p>
        <p>El widget de chat debería aparecer en la esquina inferior derecha.</p>
        <p>Configuración personalizada:</p>
        <ul>
            <li>Color primario: #FF6B6B</li>
            <li>Nombre: Mi Asistente</li>
            <li>Mensaje de bienvenida: ¡Bienvenido a nuestra tienda!</li>
        </ul>
    </div>

    <!-- SDK Script - This would normally be loaded from your server -->
    <script>
        // Simulate server-side template replacement
        window.FormmyChatConfig = {
            apiKey: 'test-api-key',
            chatbot: {
                name: 'Mi Asistente',
                id: 'test-chatbot-id',
                primaryColor: '#FF6B6B',
                welcomeMessage: '¡Bienvenido a nuestra tienda! ¿En qué puedo ayudarte?'
            }
        };
    </script>

    <!-- This is the actual SDK script that would be embedded -->
    <script>
        // This would be the actual SDK script content
        // For testing, we'll include it inline
        (function(global, doc) {
            'use strict';
            
            const window = global || (typeof window !== 'undefined' ? window : {});
            const document = doc || (typeof document !== 'undefined' ? document : {});
            
            if (!window || !document) return;
            if (window.FormmyChatSDK && window.FormmyChatSDK.isInitialized) return;

            // Use the config from above or defaults
            const config = window.FormmyChatConfig || {
                apiKey: '',
                chatbot: {
                    name: 'Chatbot',
                    id: 'default',
                    primaryColor: '#6366F1',
                    welcomeMessage: '¡Hola! ¿Cómo puedo ayudarte hoy?'
                }
            };

            const FormmyChatSDK = {
                config: config,
                sessionId: null,
                isInitialized: false,
                elements: {},

                hexToRgb: function(hex) {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? 
                        parseInt(result[1], 16) + ',' + parseInt(result[2], 16) + ',' + parseInt(result[3], 16) :
                        '99,102,241';
                },

                init: function() {
                    if (this.isInitialized) return;
                    this.sessionId = "session_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                    this.createChatWidget();
                    this.createToggleButton();
                    this.isInitialized = true;
                    console.log("Formmy Chat SDK initialized for third-party site");
                },

                createChatWidget: function() {
                    this.primaryColor = this.config.chatbot.primaryColor || "#6366F1";
                    this.welcomeMessage = this.config.chatbot.welcomeMessage || "¡Hola! ¿Cómo puedo ayudarte hoy?";
                    this.botName = this.config.chatbot.name || "Chatbot";

                    const container = document.createElement("main");
                    container.id = "formmy-chat-widget";
                    container.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        width: 100%;
                        max-width: 400px;
                        height: 600px;
                        background: rgba(${this.hexToRgb(this.primaryColor)}, 0.125);
                        border-radius: 0.75rem;
                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                        display: none;
                        flex-direction: column;
                        z-index: 9999;
                        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        overflow: hidden;
                    `;

                    const article = document.createElement("article");
                    article.style.cssText = `
                        height: 100%;
                        background: #fff;
                        border-radius: 0.75rem;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    `;

                    // Header
                    const header = document.createElement("header");
                    header.style.cssText = `
                        background: ${this.primaryColor};
                        color: white;
                        padding: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        border-bottom: 1px solid #e5e7eb;
                    `;

                    const avatar = document.createElement("div");
                    avatar.style.cssText = `
                        width: 2rem;
                        height: 2rem;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 0.875rem;
                    `;
                    avatar.textContent = this.botName.charAt(0).toUpperCase();

                    const name = document.createElement("h3");
                    name.style.cssText = `margin: 0; font-size: 1rem; font-weight: 600;`;
                    name.textContent = this.botName;

                    const closeButton = document.createElement("button");
                    closeButton.id = "formmy-close-btn";
                    closeButton.style.cssText = `
                        margin-left: auto;
                        background: none;
                        border: none;
                        color: white;
                        font-size: 1.5rem;
                        cursor: pointer;
                        padding: 0;
                        width: 2rem;
                        height: 2rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    closeButton.innerHTML = "×";
                    closeButton.onclick = () => this.toggleChat();

                    header.appendChild(avatar);
                    header.appendChild(name);
                    header.appendChild(closeButton);

                    // Messages container
                    const messagesContainer = document.createElement("div");
                    messagesContainer.id = "formmy-messages-container";
                    messagesContainer.style.cssText = `
                        flex: 1;
                        overflow-y: auto;
                        padding: 1rem;
                        display: flex;
                        flex-direction: column;
                        gap: 0.75rem;
                    `;

                    // Welcome message
                    const welcomeDiv = document.createElement("div");
                    welcomeDiv.style.cssText = `
                        display: flex;
                        align-items: flex-start;
                        gap: 0.75rem;
                        padding: 0 1rem;
                    `;
                    
                    const welcomeAvatar = document.createElement("div");
                    welcomeAvatar.style.cssText = `
                        width: 2rem;
                        height: 2rem;
                        border-radius: 50%;
                        background: ${this.primaryColor};
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 0.75rem;
                        flex-shrink: 0;
                    `;
                    welcomeAvatar.textContent = this.botName.charAt(0).toUpperCase();
                    
                    const welcomeBubble = document.createElement("div");
                    welcomeBubble.style.cssText = `
                        background: white;
                        border-radius: 0.5rem;
                        padding: 0.75rem;
                        max-width: 24rem;
                        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                    `;
                    
                    const welcomeText = document.createElement("div");
                    welcomeText.style.cssText = `
                        font-size: 0.875rem;
                        line-height: 1.25;
                        color: #111827;
                        margin: 0;
                    `;
                    welcomeText.textContent = this.welcomeMessage;
                    
                    welcomeBubble.appendChild(welcomeText);
                    welcomeDiv.appendChild(welcomeAvatar);
                    welcomeDiv.appendChild(welcomeBubble);
                    messagesContainer.appendChild(welcomeDiv);

                    // Input area
                    const inputArea = document.createElement("div");
                    inputArea.style.cssText = `
                        padding: 1rem;
                        border-top: 1px solid #e5e7eb;
                        display: flex;
                        gap: 0.5rem;
                        align-items: flex-end;
                    `;

                    const input = document.createElement("input");
                    input.type = "text";
                    input.placeholder = "Escribe tu mensaje...";
                    input.style.cssText = `
                        flex: 1;
                        padding: 0.75rem;
                        border: 1px solid #d1d5db;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        outline: none;
                        transition: border-color 0.2s;
                        border-color: ${this.primaryColor};
                    `;

                    const sendButton = document.createElement("button");
                    sendButton.textContent = "Enviar";
                    sendButton.style.cssText = `
                        padding: 0.5rem 1rem;
                        background: ${this.primaryColor};
                        color: white;
                        border: none;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background-color 0.2s;
                        white-space: nowrap;
                        height: 2.5rem;
                        min-width: 4rem;
                    `;

                    inputArea.appendChild(input);
                    inputArea.appendChild(sendButton);

                    article.appendChild(header);
                    article.appendChild(messagesContainer);
                    article.appendChild(inputArea);
                    container.appendChild(article);
                    document.body.appendChild(container);

                    this.elements = {
                        ...this.elements,
                        container,
                        article,
                        header,
                        messagesContainer,
                        input,
                        sendButton
                    };

                    // Event listeners
                    input.addEventListener("keypress", (e) => {
                        if (e.key === "Enter") {
                            this.handleSendMessage();
                        }
                    });
                    sendButton.addEventListener("click", () => this.handleSendMessage());
                },

                createToggleButton: function() {
                    const toggleButton = document.createElement("button");
                    toggleButton.id = "formmy-chat-toggle";
                    toggleButton.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        width: 60px;
                        height: 60px;
                        border-radius: 50%;
                        background: ${this.primaryColor || '#6366F1'} !important;
                        color: white !important;
                        border: none;
                        cursor: pointer;
                        font-size: 24px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                        z-index: 10001;
                        display: flex !important;
                        align-items: center;
                        justify-content: center;
                        transition: transform 0.2s ease;
                        opacity: 1 !important;
                    `;
                    toggleButton.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;

                    document.body.appendChild(toggleButton);
                    this.elements.toggleButton = toggleButton;
                    toggleButton.addEventListener("click", () => this.toggleChat());
                },

                toggleChat: function(show = null) {
                    const { container, toggleButton } = this.elements;
                    if (!container) return;

                    const isVisible = container.style.display === 'flex';
                    const shouldShow = show !== null ? show : !isVisible;

                    container.style.display = shouldShow ? 'flex' : 'none';
                    if (toggleButton) {
                        toggleButton.style.display = shouldShow ? 'none' : 'flex';
                    }
                },

                handleSendMessage: function() {
                    const { input, messagesContainer } = this.elements;
                    const message = input.value.trim();
                    
                    if (!message) return;

                    // Add user message
                    const userDiv = document.createElement("div");
                    userDiv.style.cssText = `
                        display: flex;
                        align-items: flex-start;
                        gap: 0.75rem;
                        justify-content: flex-end;
                        padding: 0 1rem;
                    `;

                    const userBubble = document.createElement("div");
                    userBubble.style.cssText = `
                        background: ${this.primaryColor};
                        color: white;
                        border-radius: 0.5rem;
                        padding: 0.5rem;
                        max-width: 16rem;
                    `;

                    const userText = document.createElement("div");
                    userText.style.cssText = `
                        font-size: 0.875rem;
                        color: white;
                        line-height: 1.25;
                        margin: 0;
                    `;
                    userText.textContent = message;

                    userBubble.appendChild(userText);
                    userDiv.appendChild(userBubble);
                    messagesContainer.appendChild(userDiv);

                    // Clear input
                    input.value = '';
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    // Simulate bot response
                    setTimeout(() => {
                        const botDiv = document.createElement("div");
                        botDiv.style.cssText = `
                            display: flex;
                            align-items: flex-start;
                            gap: 0.75rem;
                            padding: 0 1rem;
                        `;

                        const botAvatar = document.createElement("div");
                        botAvatar.style.cssText = `
                            width: 2rem;
                            height: 2rem;
                            border-radius: 50%;
                            background: ${this.primaryColor};
                            color: white;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 0.75rem;
                            flex-shrink: 0;
                        `;
                        botAvatar.textContent = this.botName.charAt(0).toUpperCase();

                        const botBubble = document.createElement("div");
                        botBubble.style.cssText = `
                            background: white;
                            border-radius: 0.5rem;
                            padding: 0.75rem;
                            max-width: 24rem;
                            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                        `;

                        const botText = document.createElement("div");
                        botText.style.cssText = `
                            font-size: 0.875rem;
                            line-height: 1.25;
                            color: #111827;
                            margin: 0;
                        `;
                        botText.textContent = `Gracias por tu mensaje: "${message}". Esto es una respuesta simulada.`;

                        botBubble.appendChild(botText);
                        botDiv.appendChild(botAvatar);
                        botDiv.appendChild(botBubble);
                        messagesContainer.appendChild(botDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 1000);
                }
            };

            // Initialize when DOM is ready
            function initializeSDK() {
                if (!window.FormmyChatSDK || !window.FormmyChatSDK.isInitialized) {
                    window.FormmyChatSDK = FormmyChatSDK;
                    FormmyChatSDK.init();
                }
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initializeSDK);
            } else {
                initializeSDK();
            }

            window.FormmyChatSDK = FormmyChatSDK;
        })(typeof window !== 'undefined' ? window : this, typeof document !== 'undefined' ? document : {});
    </script>
</body>
</html>
